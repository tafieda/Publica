<?php
session_start();
include('includes/config.php');
include('includes/header.php');
include('includes/navbar.php');
error_reporting(0);
if(strlen($_SESSION['login'])==0)
  { 
header('location:logout.php');
}
else{
if(isset($_POST['submit']))
{
    //$_SESSION['login']=$_POST['username'];
    $adminid=$_SESSION['login'];
//Current Password hashing 
$password=$_POST['password'];
$options = ['cost' => 12];
$hashedpass=password_hash($password, PASSWORD_BCRYPT, $options);

// new password hashing 
$newpassword=$_POST['newpassword'];
$newhashedpass=password_hash($newpassword, PASSWORD_BCRYPT, $options);

//date_default_timezone_set('Africa/Lagos');// change according timezone
//$currentTime = date( 'd-m-Y h:i:s A', time () );
//UpdationDate='$currentTime'
$sql=mysqli_query($con,"SELECT AdminPassword FROM  tbladmin where AdminUserName='$adminid' || AdminEmailId='$adminid'");
$num=mysqli_fetch_array($sql);
if($num>0)
{
 $dbpassword=$num['AdminPassword'];

if (password_verify($password, $dbpassword)) {

    $query=mysqli_query($con,"update tbladmin set AdminPassword='$newhashedpass',  where AdminUserName='$adminid'");
$msg="Password Changed Successfully !!!";
}
}
else
{
$error="Old Password not match !!";
}
}


?>



<!--script type="text/javascript">
    function valid() {
        if (document.chngpwd.password.value == "") {
            alert("Current Password Filed is Empty !!");
            document.chngpwd.password.focus();
            return false;
        } else if (document.chngpwd.newpassword.value == "") {
            alert("New Password Filed is Empty !!");
            document.chngpwd.newpassword.focus();
            return false;
        } else if (document.chngpwd.confirmpassword.value == "") {
            alert("Confirm Password Filed is Empty !!");
            document.chngpwd.confirmpassword.focus();
            return false;
        } else if (document.chngpwd.newpassword.value != document.chngpwd.confirmpassword.value) {
            alert("Password and Confirm Password Field do not match  !!");
            document.chngpwd.confirmpassword.focus();
            return false;
        }
        return true;
    }
</script-->

<!-- Begin Page Content -->
<div class="container-fluid">

    <!-- Page Heading -->

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Change Password</h1>

        <!---Success Message--->
        <?php if($msg){ ?>
        <div class="alert alert-success" role="alert">
            <strong>Well done!</strong> <?php echo htmlentities($msg);?>
        </div>
        <?php } ?>

        <!---Error Message--->
        <?php if($error){ ?>
        <div class="alert alert-danger" role="alert">
            <strong>Oh snap!</strong> <?php echo htmlentities($error);?></div>
        <?php } ?>


    </div>



    <script type="text/javascript">
function valid()
{
if(document.chngpwd.newpassword.value!=document.chngpwd.confirmpassword.value)
{
alert('New Password and Confirm Password field does not match');
document.chngpwd.confirmpassword.focus();
return false;
}
return true;
}   

</script>


    
    <form class="form-horizontal" method="post" onsubmit="return valid();" name="chngpwd" method="post">
                                                      
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h5 mb-0 text-gray-800">Current Password</h1>
        </div>
        <div class="d-sm-flex align-items-center justify-content-between mb-4">

            <input type="text" class="form-control" value="<?php echo htmlentities($row['AdminPassword']);?>" name="password" required>
            <?php echo ($row['AdminPassword']);?>    </div>


        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h5 mb-0 text-gray-800">New Password</h1>
        </div>
        <div class="d-sm-flex align-items-center justify-content-between mb-4">

            <input type="text" class="form-control" value="" name="newpassword" required>
        </div>



        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h5 mb-0 text-gray-800">Confirm Password</h1>
        </div>
        <div class="d-sm-flex align-items-center justify-content-between mb-4">

            <input type="text" class="form-control" value="" name="confirmpassword" required>
        </div>


        <div class="form-group">
            <label class="col-md-4 control-label">&nbsp;</label>
            <div class="d-sm-flex align-items-center justify-content-between mb-4">


                <button type="submit" class="btn btn-success waves-effect waves-light btn-md" name="submit">
                    Submit
                </button>
            </div>
        </div>

    </form>



</div>














<?php
include('includes/scripts.php');
include('includes/footer.php');
 
?>


<script>
    var resizefunc = [];
</script>

<!-- jQuery  -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/detect.js"></script>
<script src="assets/js/fastclick.js"></script>
<script src="assets/js/jquery.blockUI.js"></script>
<script src="assets/js/waves.js"></script>
<script src="assets/js/jquery.slimscroll.js"></script>
<script src="assets/js/jquery.scrollTo.min.js"></script>
<script src="../plugins/switchery/switchery.min.js"></script>

<!-- App js -->
<script src="assets/js/jquery.core.js"></script>
<script src="assets/js/jquery.app.js"></script>


<?php } ?>